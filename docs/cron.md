
<iframe width="600" height="800" src="//player.bilibili.com/player.html?aid=517576433&bvid=BV1Lg411q79K&cid=890116468&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe>


之前接到一个需求，要求每周日10点执行一个定时任务。我想那不简单，使用 node-schedule，它的简单使用如下：

```
const schedule = require('node-schedule');

// 当前时间的秒值为 10 时执行任务，如：2018-7-8 13:25:10
let job = schedule.scheduleJob('10 * * * * *', () => {
  console.log(new Date());
});
```
其中  `10 * * * * *` 就是 cron 表达式。

它的语法是怎样的呢？可以看以下：

```
*  *  *  *  *  *
┬  ┬  ┬  ┬  ┬  ┬
│  │  │  │  │  |
│  │  │  │  │  └ 星期几，取值：0 - 7，其中 0 和 7 都表示是周日
│  │  │  │  └─── 月份，取值：1 - 12
│  │  │  └────── 日期，取值：1 - 31
│  │  └───────── 时，取值：0 - 23
│  └──────────── 分，取值：0 - 59
└─────────────── 秒，取值：0 - 59（可选）
```

然后那个星号代表什么呢？
`*` 代表所有可能的值。在月域中，`*` 表示每个月；在星期域中，`*` 表示星期的每一天。

OK，那我就写了以下的表达式：

```
0 0 22 * * 7
```

感觉没问题，对吧。。。几个月之后的某天，我们发现定时任务竟然只跑了一次？？？

我有点懵，然后去排查我的代码逻辑，好像又没有什么问题，后来在想难道定时任务的时机定错了？然后我又回去看了一下定时任务的设置。看到常见示例中有一个跟我很类似的：

```
0 0 12 ? * WED
```

说明一下：星期有两种表示方式：[1, 7] 或 [MON, SUN]。若您使用 [1, 7] 表达方式，1 代表星期一，7代表星期日。

发现它这个日期使用的是问号，那这个又代表什么呢？
它代表着：不指定值，仅日期和星期域支持该字符。**当日期或星期域其中之一被指定了值以后，为了避免冲突，需要将另一个域的值设为?。**

举个例子：
要在每月的 20 号触发调度，不管每个月的 20 号是星期几，则只能使用如下写法：13 13 15 20 * ?。其中，因为日期域已经指定了 20 号，最后一位星期域只能用 ?，不能使用 *。如果最后一位使用 *，则表示不管星期几都会触发，与日期域的 20 号相斥，此时表达式不正确。


所以最终我要修改成:
```
0 0 22 ? * 7
```

这样就解决了。。

